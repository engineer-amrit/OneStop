name: CI

on:
  push:
    branches:
      - main
      - develop

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}

    steps:
      - uses: actions/checkout@v4

      - name: Get affected packages
        run: |
          turbo run build --affected --output=json > changes.json

      - name: Build matrix
        id: matrix
        run: |
          ALLOWED='["@web/ecom-admin","@backend/ecom"]'

          MATRIX=$(jq -c --argjson allowed "$ALLOWED" '
            .packages.items
            | map(
                select(.name as $n | $allowed | index($n))
                | {
                    scope: .name,
                    image: (.name | split("/")[-1] | gsub("^ecom-"; ""))
                  }
              )
          ' changes.json)

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  build:
    needs: detect
    if: needs.detect.outputs.matrix != '[]'
    runs-on: ubuntu-latest

    strategy:
      matrix:
        app: ${{ fromJson(needs.detect.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable pnpm
        run: corepack enable

      - name: Turbo prune
        run: |
          turbo prune \
            --scope=${{ matrix.app.scope }} \
            --docker \
            --out-dir=pruned

      - name: Pull cache image if exists
        run: |
          IMAGE=${{ secrets.DOCKER_USERNAME }}/${{ matrix.app.image }}
          docker pull $IMAGE:latest || true

      - name: Docker build
        run: |
          IMAGE=${{ secrets.DOCKER_USERNAME }}/${{ matrix.app.image }}

          docker build \
            -f pruned/Dockerfile \
            -t $IMAGE:${{ github.sha }} \
            -t $IMAGE:latest \
            --cache-from=$IMAGE:latest \
            --build-arg TURBO_TOKEN=${{ secrets.TURBO_TOKEN }} \
            --build-arg TURBO_TEAM=${{ secrets.TURBO_TEAM }} \
            pruned

      - name: Push images
        run: |
          IMAGE=${{ secrets.DOCKER_USERNAME }}/${{ matrix.app.image }}

          docker push $IMAGE:${{ github.sha }}
          docker push $IMAGE:latest
